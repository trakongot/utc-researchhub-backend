// --------------------------- CLIENT & DATASOURCE CONFIGURATION ------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------- UTIL ENUM  ------------------------

enum UserT {
  STUDENT
  ADMIN
  DEAN
  DEPARTMENT_HEAD
  SECRETARY
  LECTURER
  ADVISOR
}

enum TopicT {
  GRADUATED // Đồ án
  RESEARCH // Nghiên cứu khoa học''
  COMPETITION // Dự án thi đấu
  COLLABORATION // Dự án hợp tác
}

enum FileT {
  PDF
  WORD
  PRESENTATION
  SPREADSHEET
  AUTOCAD
  IMAGE
  VIDEO
  CODE
  DATASET
  OTHER
}

// --------------------------- USER MANAGEMENT ------------------------

enum StudentStatusT {
  ACTIVE
  INACTIVE
  GRADUATED
  DROPPED_OUT
  ON_LEAVE
}

enum GenderT {
  MALE
  FEMALE
  OTHER
}

model Student {
  id             String         @id @default(cuid()) // ID duy nhất của sinh viên
  studentCode    String         @unique @map("student_code") // Mã sinh viên
  majorCode      String?        @map("major_code") // Mã ngành của sinh viên
  programCode    String?        @map("program_code") // Mã chương trình học
  bio            String?        @map("bio") // Giới thiệu bản thân
  fullName       String         @map("full_name") @db.VarChar(255) // Họ và tên đầy đủ
  email          String         @unique @db.VarChar(255) // Email
  password       String         @map("password") // Mật khẩu
  phone          String?        @map("phone") @db.VarChar(20) // Số điện thoại
  dateOfBirth    DateTime?      @map("date_of_birth") // Ngày sinh
  gender         GenderT?       @map("gender") // Giới tính
  admissionYear  Int?           @map("admission_year") // Năm nhập học
  graduationYear Int?           @map("graduation_year") // Năm tốt nghiệp dự kiến
  currentGpa     Float?         @map("current_gpa") // Điểm trung bình tích lũy (GPA)
  creditsEarned  Int?           @map("credits_earned") // Số tín chỉ tích lũy
  status         StudentStatusT @default(ACTIVE) @map("status") // Trạng thái sinh viên
  createdAt      DateTime       @default(now()) @map("created_at") // Ngày tạo hồ sơ
  updatedAt      DateTime       @updatedAt @map("updated_at") // Ngày cập nhật hồ sơ gần nhất
  profilePicture String?        @map("profile_pic") // Ảnh đại diện
  lastLogin      DateTime?      @map("last_login") // Lần đăng nhập gần nhất
  isOnline       Boolean        @default(false) @map("is_online") // Trạng thái trực tuyến

  department   Department? @relation(fields: [departmentId], references: [id])
  departmentId String?     @map("department_id") // Mã khoa của sinh viên

  ProjectComment       ProjectComment[]       @relation
  AuditLog             AuditLog[]             @relation
  ProposalOutline      ProposalOutline[]      @relation
  ProposedProject      ProposedProject[]      @relation("ProposedProjectCreatedByStudent")
  StudentSelection     StudentSelection[]     @relation
  ProjectAllocation    ProjectAllocation[]    @relation
  ProjectFinalReport   ProjectFinalReport[]   @relation
  ProjectReportFile    ProjectReportFile[]    @relation
  ProjectReportComment ProjectReportComment[] @relation

  @@index([studentCode, email, status])
  @@map("student")
}

enum FacultyStatusT {
  ACTIVE
  INACTIVE
  RETIRED
  RESIGNED
  ON_LEAVE
}

model Faculty {
  id             String         @id
  fullName       String         @map("full_name") @db.VarChar(255)
  facultyCode    String?        @unique @map("faculty_member_code") @db.VarChar(50)
  bio            String?        @map("bio")
  email          String         @unique @map("email") @db.VarChar(255)
  password       String         @map("password")
  status         FacultyStatusT @default(ACTIVE) @map("status")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  // isDeleted      Boolean        @default(false) @map("is_deleted")
  profilePicture String?        @map("profile_picture")
  lastLogin      DateTime?      @map("last_login")
  isOnline       Boolean        @default(false) @map("is_online")

  phoneNumber String? @map("phone_number") // Số điện thoại
  rank        String? @map("rank") // Học hàm/học vị

  departmentId String? @map("department_id")

  Department               Department?              @relation(fields: [departmentId], references: [id])
  DefenseMember            DefenseMember[]          @relation
  ProjectEvaluationScore   ProjectEvaluationScore[] @relation
  ProjectEvaluation        ProjectEvaluation[]      @relation
  FacultyRole              FacultyRole[]            @relation
  EvaluationCriteria       EvaluationCriteria[]     @relation
  ProjectComment           ProjectComment[]         @relation
  Project                  Project[]                @relation
  AuditLog                 AuditLog[]               @relation
  ProposalOutline          ProposalOutline[]        @relation
  CreatedProposedProject   ProposedProject[]        @relation("ProposedProjectCreatedByFaculty")
  ApprovedProposedProject  ProposedProject[]        @relation("ProposedProjectApprovedByFaculty")
  DefenseCommittee         DefenseCommittee[]       @relation
  LecturerSelection        LecturerSelection[]      @relation
  StudentSelection         StudentSelection[]       @relation
  ProjectFinalReport       ProjectFinalReport[]     @relation
  ProjectReportFile        ProjectReportFile[]      @relation
  ProjectReportComment     ProjectReportComment[]   @relation
  CreatedByFacultyRelation ProjectAllocation[]      @relation("CreatedByFacultyRelation")
  LecturerRelation         ProjectAllocation[]      @relation("LecturerRelation")

  @@index([facultyCode, email, status])
  @@map("facuty")
}

enum FacultyRoleT {
  ADMIN
  DEAN
  DEPARTMENT_HEAD
  SECRETARY
  LECTURER
  ADVISOR
}

model FacultyRole {
  id        String       @id
  facultyId String       @map("faculty_id")
  role      FacultyRoleT @map("role")

  Faculty Faculty @relation(fields: [facultyId], references: [id])

  @@unique([facultyId, role])
  @@map("faculty_role")
}

// --------------------------- ACADEMIC MANAGEMENT ------------------------

enum DepartmentStatusT {
  ACTIVE // Khoa đang hoạt động
  INACTIVE // Khoa đã giải thể hoặc tạm ngừng
}

model Department {
  id             String            @id @default(uuid())
  departmentCode String?           @map("department_code") // Mã khoa
  name           String            @unique @map("name") @db.VarChar(255) // Tên khoa
  description    String?           @map("description") // Mô tả khoa
  status         DepartmentStatusT @default(ACTIVE) @map("status") // Trạng thái khoa
  createdAt      DateTime          @default(now()) @map("created_at") // Thời gian tạo
  updatedAt      DateTime          @updatedAt @map("updated_at") // Thời gian cập nhật

  parentDepartmentId String? @map("parent_department_id") // Khoa cha (nếu có)

  ParentDepartment    Department?           @relation("SubDepartment", fields: [parentDepartmentId], references: [id]) // Quan hệ tự tham chiếu
  SubDepartment       Department[]          @relation("SubDepartment") // Các khoa con
  Student             Student[]             @relation
  Faculty             Faculty[]             @relation
  Project             Project[]             @relation
  AuditLog            AuditLog[]            @relation
  ProjectFinalReport  ProjectFinalReport[]  @relation
  FieldPoolDepartment FieldPoolDepartment[] @relation

  @@map("department")
}

// --------------------------- REGISTER MANAGEMENT ------------------------

model FieldPool {
  id          String   @id @default(uuid())
  name        String   @unique @map("name")
  description String?  @map("description")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  FieldPoolDepartments FieldPoolDepartment[] @relation
  LecturerSelections   LecturerSelection[]   @relation
  StudentSelections    StudentSelection[]    @relation
  FieldPoolTags        FieldPoolTag[]        @relation

  @@map("field_pool")
}

model FieldPoolDepartment {
  fieldPoolId  String   @map("field_pool_id")
  departmentId String   @map("department_id")
  assignedAt   DateTime @default(now())

  Department Department @relation(fields: [departmentId], references: [id])
  FieldPool  FieldPool  @relation(fields: [fieldPoolId], references: [id])

  @@id([fieldPoolId, departmentId])
  @@map("field_pool_department")
}

model FieldPoolTag {
  fieldPoolId String @map("field_pool_id")
  tagId       String @map("tag_id")

  Tag       Tag       @relation(fields: [tagId], references: [id])
  FieldPool FieldPool @relation(fields: [fieldPoolId], references: [id])

  @@id([fieldPoolId, tagId])
  @@map("field_pool_tag")
}

model Tag {
  id          String   @id @default(uuid())
  name        String   @unique @map("name") // Tên tag (ví dụ: "AI", "Blockchain")
  description String?  @map("description")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  FieldPoolTag         FieldPoolTag[]         @relation
  LecturerSelectionTag LecturerSelectionTag[] @relation
  StudentSelectionTag  StudentSelectionTag[]  @relation

  @@map("tag")
}

model LecturerSelectionTag {
  lecturerSelectionId String @map("lecturer_selection_id")
  tagId               String @map("tag_id")

  Tag               Tag               @relation(fields: [tagId], references: [id])
  LecturerSelection LecturerSelection @relation(fields: [lecturerSelectionId], references: [id])

  @@id([lecturerSelectionId, tagId])
  @@index([lecturerSelectionId])
  @@map("lecturer_selection_tag")
}

model StudentSelectionTag {
  studentSelectionId String @map("student_selection_id")
  tagId              String @map("tag_id")

  Tag              Tag              @relation(fields: [tagId], references: [id])
  StudentSelection StudentSelection @relation(fields: [studentSelectionId], references: [id])

  @@id([studentSelectionId, tagId])
  @@map("student_selection_tag")
}

model LecturerSelection {
  id          String   @id @default(uuid())
  priority    Int      @default(1) // Thứ tự nguyện vọng (1 là cao nhất)
  topicTitle  String   @map("topic_title") // Tiêu đề đề tài
  description String? // Mô tả
  capacity    Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  isActive    Boolean  @default(true) @map("is_active")
  lecturerId  String   @map("lecturer_id")
  fieldPoolId String?  @map("field_pool_id")

  Lecturer  Faculty                @relation(fields: [lecturerId], references: [id])
  FieldPool FieldPool?             @relation(fields: [fieldPoolId], references: [id])
  Tag       LecturerSelectionTag[]

  @@unique([lecturerId, topicTitle])
  @@map("lecturer_selection")
}

enum StudentSelectionStatusT {
  PENDING
  APPROVED
  REJECTED
}

model StudentSelection {
  id          String                  @id @default(uuid())
  priority    Int                     @default(1) // Thứ tự nguyện vọng (1 là cao nhất)
  preferredAt DateTime                @default(now())
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  status      StudentSelectionStatusT @default(PENDING)

  studentId       String  @map("student_id")
  facultyMemberId String  @map("faculty_member_id")
  fieldPoolId     String? @map("field_pool_id")

  Lecturer  Faculty               @relation(fields: [facultyMemberId], references: [id])
  Student   Student               @relation(fields: [studentId], references: [id])
  Tag       StudentSelectionTag[]
  FieldPool FieldPool[]

  @@unique([studentId, facultyMemberId, priority])
  @@index([studentId, priority])
  @@index([facultyMemberId, createdAt, status])
  @@map("student_selection")
}

model ProjectAllocation {
  id          String   @id @default(uuid())
  topicTitle  String
  allocatedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  studentId   String   @map("student_id")
  createdById String   @map("created_by_id")
  lecturerId  String   @map("lecturer_id")

  Student          Student @relation(fields: [studentId], references: [id])
  Lecturer         Faculty @relation("LecturerRelation", fields: [lecturerId], references: [id])
  CreatedByFaculty Faculty @relation("CreatedByFacultyRelation", fields: [createdById], references: [id])

  @@unique([studentId, lecturerId, topicTitle])
  @@index([studentId, lecturerId, allocatedAt])
  @@map("project_allocation")
}

// --------------------------- REGISTER PROJECT ------------------------

enum ProposedProjectStatusT {
  PENDING_ADVISOR
  REQUESTED_CHANGES_ADVISOR
  REJECTED_BY_ADVISOR
  ADVISOR_APPROVED
  REQUESTED_CHANGES_HEAD
  REJECTED_BY_HEAD
  APPROVED_BY_HEAD
}

model ProposedProject {
  id                String                 @id
  title             String                 @map("title")
  description       String?                @map("description")
  status            ProposedProjectStatusT @default(PENDING_ADVISOR) @map("status")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  proposalDeadline  DateTime?              @map("proposal_deadline")
  topicLockDate     DateTime?              @map("topic_lock_date")
  approvedAt        DateTime?              @map("approved_at")
  approvedById      String?                @map("approved_by_id")
  proposalOutlineId String?                @map("proposal_outline_id")
  createdById       String                 @map("created_by_id")
  creatorType       UserT                  @map("creator_type")

  createdByStudent       Student?                 @relation("ProposedProjectCreatedByStudent", fields: [createdById], references: [id], map: "fk_draft_topic_student")
  createdByfaculty       Faculty?                 @relation("ProposedProjectCreatedByFaculty", fields: [createdById], references: [id], map: "fk_draft_topic_faculty")
  members                ProjectMember[]          @relation("ProposedProjectMembers")
  proposalOutline        ProposalOutline?         @relation(fields: [proposalOutlineId], references: [id])
  approvedBy             Faculty?                 @relation("ProposedProjectApprovedByFaculty", fields: [approvedById], references: [id])
  ProposedProjectComment ProposedProjectComment[]

  @@map("proposed_project")
}

model ProposedProjectComment {
  id          String   @id
  commenterId String?  @map("commenter_id")
  role        UserT    @map("role")
  content     String   @map("content")
  createdAt   DateTime @default(now()) @map("created_at")

  proposedProjectId String          @map("study_topic_darf_id")
  Propose           ProposedProject @relation(fields: [proposedProjectId], references: [id])

  @@map("proposed_project_comment")
}

enum ProposalStatusT {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

model ProposalOutline {
  id              String          @id
  introduction    String          @map("introduction") // Giới thiệu đề tài
  objectives      String          @map("objectives") // Mục tiêu nghiên cứu
  methodology     String          @map("methodology") // Phương pháp nghiên cứu
  expectedResults String          @map("expected_results") // Kết quả mong đợi
  fileUrl         String          @map("file_url")
  fileSize        Int?            @map("file_size")
  status          ProposalStatusT @default(PENDING_REVIEW) @map("status")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  createdById     String          @map("created_by_id")
  creatorType     UserT           @map("creator_type")

  CreatedByStudent Student?          @relation(fields: [createdById], references: [id], map: "fk_proposal_student")
  CreatedByFaculty Faculty?          @relation(fields: [createdById], references: [id], map: "fk_proposal_faculty")
  ProposedProject  ProposedProject[]
  Project          Project[]

  @@map("proposal_outline")
}

// ----------------------- MEMBER DRAFT TOPIC, PROJECT MANAGEMENT ------------------------

enum ProjectMemberStatusT {
  PENDING
  APPROVED
  LOCKED
}

model ProjectMember {
  id          String               @id
  projectId   String               @map("topic_id")
  projectType TopicT               @map("topic_type")
  memberId    String               @map("member_id")
  role        UserT                @map("role")
  descRole    String?              @map("desc_role")
  status      ProjectMemberStatusT @default(PENDING) @map("status")
  createdAt   DateTime             @default(now()) @map("created_at")
  updatedAt   DateTime             @updatedAt @map("updated_at")

  Project         Project?         @relation("ProjectMembers", fields: [projectId], references: [id], map: "fk_topic_member_project", onDelete: NoAction, onUpdate: NoAction)
  ProposedProject ProposedProject? @relation("ProposedProjectMembers", fields: [projectId], references: [id], map: "fk_topic_member_draft_topic", onDelete: NoAction, onUpdate: NoAction)

  @@unique([projectId, memberId, projectType])
  @@index([projectId, memberId])
  @@map("project_member")
}

// --------------------------- PROJECT MANAGEMENT ------------------------

enum ProjectStatusT {
  IN_PROGRESS
  WAITING_FOR_EVALUATION
  COMPLETED
}

model Project {
  id                String         @id
  type              TopicT         @map("type")
  title             String         @map("title")
  description       String?        @map("description") // Mô tả đề tài
  field             String         @map("field") // Lĩnh vực/ngành
  status            ProjectStatusT @default(IN_PROGRESS) @map("status")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  proposalDeadline  DateTime?      @map("proposal_deadline") // Hạn chót nộp đề cương
  topicLockDate     DateTime?      @map("topic_lock_date") // Thời gian khóa đề tài
  customFields      Json?          @map("custom_fields") // Các trường dữ liệu tùy chỉnh
  proposalOutlineId String?        @map("proposal_outline_id")

  approvedById   String  @map("approved_by_id")
  approvedByType UserT   @map("approved_by_type")
  departmentId   String? @map("department_id")

  Department         Department?          @relation(fields: [departmentId], references: [id])
  ApprovedBy         Faculty?             @relation(fields: [approvedById], references: [id])
  Members            ProjectMember[]      @relation("ProjectMembers")
  ProposalOutline    ProposalOutline?     @relation(fields: [proposalOutlineId], references: [id])
  Keyword            ProjectKeyword[]     @relation
  ProjectComment     ProjectComment[]     @relation
  ProjectEvaluation  ProjectEvaluation[]  @relation
  DefenseCommittee   DefenseCommittee?    @relation
  ProjectFinalReport ProjectFinalReport[] @relation

  @@index([type, status, createdAt])
  @@index([proposalOutlineId])
  @@index([departmentId])
  @@map("project")
}

enum MemberStatusT {
  PENDING // Chưa duyệt
  APPROVED // Đã duyệt
  LOCKED // Bị khóa (Không thể thay đổi)
}

model ProjectComment {
  id          String   @id
  content     String   @map("content")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  projectId   String   @map("study_topic_id")
  commenterId String   @map("commenter_id")
  role        UserT    @map("role")

  Project Project  @relation(fields: [projectId], references: [id])
  Student Student? @relation(fields: [commenterId], references: [id], map: "fk_project_comment_student")
  Faculty Faculty? @relation(fields: [commenterId], references: [id], map: "fk_project_comment_faculty")

  @@map("project_comment")
}

model ProjectKeyword {
  id        String @id
  projectId String @map("study_topic_id")
  keyword   String @map("keyword")

  Project Project @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@map("project_keyword")
}

// ------------------------- TOPIC DEFENSE MANAGEMENT ------------------------

model ProjectFinalReport {
  id         String  @id
  project    Project @relation(fields: [projectId], references: [id])
  projectId  String  @map("study_topic_id")
  mainReport String  @map("main_report") // Đường dẫn file PDF báo cáo chính
  fileSize   Int?    @map("file_size")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])

  uploadedById       String?  @map("uploaded_by_id")
  uploadedByType     UserT?   @map("uploaded_by_type")
  uploadedByStudent  Student? @relation(fields: [uploadedById], references: [id], map: "fk_project_final_report_student")
  uploadedByLecturer Faculty? @relation(fields: [uploadedById], references: [id], map: "fk_project_final_report_faculty")

  ProjectReportComment ProjectReportComment[] @relation
  RelatedFile          ProjectReportFile[]    @relation

  @@index([projectId])
  @@map("project_final_report")
}

enum ReportFileStatusT {
  PENDING
  APPROVED
  REJECTED
}

model ProjectReportFile {
  id            String             @id
  finalReport   ProjectFinalReport @relation(fields: [finalReportId], references: [id])
  finalReportId String             @map("final_report_id")
  fileType      FileT              @map("file_type")
  fileUrl       String             @map("file_url")
  fileSize      Int?               @map("file_size")
  isArchived    Boolean            @map("is_archived")
  status        ReportFileStatusT  @default(PENDING) @map("status")
  description   String?            @map("description") // Mô tả file
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  uploadedById  String?            @map("uploaded_by_id")

  UploadedByStudent  Student? @relation(fields: [uploadedById], references: [id], map: "fk_project_report_file_student")
  UploadedByLecturer Faculty? @relation(fields: [uploadedById], references: [id], map: "fk_project_report_file_faculty")

  @@index([finalReportId])
  @@index([isArchived])
  @@map("project_report_file")
}

model ProjectReportComment {
  id            String             @id
  finalReport   ProjectFinalReport @relation(fields: [finalReportId], references: [id])
  finalReportId String             @map("final_report_id")
  userId        String             @map("user_id")
  role          UserT              @map("role")
  content       String             @map("content")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")

  CommentedByStudent Student? @relation(fields: [userId], references: [id], map: "fk_report_comment_student")
  CommentedByFaculty Faculty? @relation(fields: [userId], references: [id], map: "fk_report_comment_faculty")

  @@index([finalReportId])
  @@map("project_report_comment")
}

enum DefenseCommitteeStatusT {
  PREPARING
  SCHEDULED
  ONGOING
  FINISHED
}

model DefenseCommittee {
  id          String                  @id
  Project     Project                 @relation(fields: [ProjectId], references: [id])
  ProjectId   String                  @unique @map("study_topic_id")
  name        String                  @map("name")
  description String?                 @map("description")
  defenseDate DateTime                @map("defense_date")
  status      DefenseCommitteeStatusT @default(SCHEDULED) @map("status")
  createdAt   DateTime                @default(now()) @map("created_at")
  updatedAt   DateTime                @updatedAt @map("updated_at")
  createdById String                  @map("created_by_id")

  Member           DefenseMember[] @relation
  CreatedByFaculty Faculty         @relation(fields: [createdById], references: [id])

  @@index([defenseDate])
  @@index([ProjectId])
  @@map("defense_committee")
}

enum DefenseCommitteeRoleT {
  CHAIRMAN // Trưởng bộ môn - Chủ tịch hội đồng
  DEAN // Trưởng khoa
  SECRETARY // Thư ký hội đồng
  REVIEWER // Giảng viên phản biện
  MEMBER // Thành viên hội đồng khác
}

model DefenseMember {
  id                 String                @id
  role               DefenseCommitteeRoleT @map("role")
  defenseCommitteeId String                @map("defense_committee_id")
  facultyMemberId    String                @map("faculty_member_id")

  DefenseCommittee DefenseCommittee @relation(fields: [defenseCommitteeId], references: [id])
  FacultyMember    Faculty          @relation(fields: [facultyMemberId], references: [id])

  @@unique([defenseCommitteeId])
  @@unique([facultyMemberId])
  @@map("defense_committee_member")
}

// --------------------------- EVALUATION RESULT TOPIC ------------------------

enum ProjectEvaluationStatusT {
  PENDING // Chưa chấm điểm
  IN_PROGRESS // Đang chấm
  COMPLETED // Đã hoàn thành
}

model ProjectEvaluation {
  id                    String                   @id
  ProjectId             String                   @unique @map("study_topic_id")
  finalScore            Float?                   @map("final_score")
  status                ProjectEvaluationStatusT @map("status")
  evaluatedById         String?                  @map("evaluated_by_id")
  teacherScore          Float?                   @map("teacher_score")
  committeeAverageScore Float?                   @map("committee_average_score")
  teacherWeight         Float?                   @default(0.3) @map("teacher_weight") // Trọng số giáo viên (30%)
  committeeWeight       Float?                   @default(0.7) @map("committee_weight") // Trọng số hội đồng (70%)
  createdAt             DateTime                 @default(now()) @map("created_at")
  updatedAt             DateTime                 @updatedAt @map("updated_at")

  Score              ProjectEvaluationScore[] @relation
  CriteriaScores     ProjectCriteriaScore[]   @relation
  Project            Project                  @relation(fields: [ProjectId], references: [id])
  EvaluatedByFaculty Faculty?                 @relation(fields: [evaluatedById], references: [id])

  @@map("project_evaluation")
}

model ProjectCriteriaScore {
  id            String  @id
  projectEvalId String  @map("study_topic_eval_id")
  criteriaId    String  @map("criteria_id")
  evaluatorId   String? @map("evaluator_id")
  score         Float   @default(0.0) @map("score")
  comment       String? @map("comment")

  EvaluationCriteria EvaluationCriteria @relation(fields: [criteriaId], references: [id])
  ProjectEvaluation  ProjectEvaluation  @relation(fields: [projectEvalId], references: [id])

  @@map("project_criteria_score")
}

model ProjectEvaluationScore {
  id                String                 @id
  role              DefenseCommitteeRoleT? @map("role")
  score             Float                  @map("score")
  comment           String?                @map("comment")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  evaluationId      String                 @map("evaluation_id")
  committeeMemberId String                 @map("committee_member_id")

  evaluation      ProjectEvaluation @relation(fields: [evaluationId], references: [id])
  committeeMember Faculty           @relation(fields: [committeeMemberId], references: [id])

  @@unique([committeeMemberId])
  @@map("project_evaluation_score")
}

model EvaluationCriteria {
  id          String   @id
  name        String   @map("name") // Tên tiêu chí
  description String?  @map("description") // Mô tả tiêu chí
  weight      Float    @default(1.0) @map("weight") // Trọng số tiêu chí
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id") // ID của người tạo tiêu chí

  CreatedByFaculty     Faculty                @relation(fields: [createdById], references: [id])
  ProjectCriteriaScore ProjectCriteriaScore[] @relation

  @@map("evaluation_criteria")
}

// --------------------------- LOG SYSTEM ------------------------

model AuditLog {
  id         String   @id
  entityType String   @map("entity_type") // Ví dụ: "PROJECT", "TASK", "SYSTEM_CONFIG"
  entityId   String?  @map("entity_id") // ID của đối tượng liên quan (Project, Task,...)
  action     String   @map("action") // "CREATE", "UPDATE", "APPROVE", "SUBMIT"
  oldValue   String?  @map("old_value") // Giá trị trước khi thay đổi
  newValue   String?  @map("new_value") // Giá trị sau khi thay đổi
  metadata   Json?    @map("metadata") // Lưu thông tin bổ sung (VD: chi tiết thay đổi)
  createdAt  DateTime @default(now()) @map("created_at")

  departmentId String?     @map("department_id")
  department   Department? @relation(fields: [departmentId], references: [id])

  userId           String   @map("user_id")
  userType         UserT    @map("user_type")
  createdByStudent Student? @relation(fields: [userId], references: [id], map: "fk_log_student")
  createdByFaculty Faculty? @relation(fields: [userId], references: [id], map: "fk_log_faculty")

  @@index([entityType, entityId, createdAt])
  @@index([userId, departmentId])
  @@map("audit_log")
}

// --------------------------- NOTIFICATION SYSTEM ------------------------
